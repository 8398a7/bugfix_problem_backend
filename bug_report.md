slack_id: 8398a7

# 仕様
- 一人のユーザーは，ひとつ商品につきひとつのみ購入可能
- 購入した商品は，再度購入は不可能
- ログイン前にカートへ追加した商品は，ログイン後にも適切に保持されている
* 基本的に現状の動きを大きく変えないようにすること

# 注意
今回のサイトでは、カートに入ったものを購入する際の処理（入金や配送先の入力）は省くものとする。
したがって、カートから購入ボタンを押したら購入は完了するものとする。

# BUG REPORT
以下のバグが報告されている。
仕様を満たすようにバグを取り除いてください。
以下の報告において、"新しい品物！"などはページにおけるナビゲーションの表記と対応している。

# Bug1
"新しい品物！"で何も選択をしない場合で，"商品を追加する"を押した時は，
同じページにリダイレクトさせたいのに，index.phpに遷移してしまう．
cardadd.php11行目ののリダイレクト先をindex.phpからnew_items.phpへ変更した．

# Bug2
login後に、"メッセージを残す"で自動的に名前の入力が投稿に反映されない
guestbook.phpでセッションにユーザが存在している場合の処理で，
値をhiddenを用いて渡すように変更した．

# Bug3
商品をすべて購入後に"新しい品物！"にアクセスすると表示がおかしくなる
new_items.phpの51行目で引っ張ってきた$itemsが空であった倍はループを終了させた．

# Bug4
"メッセージを残す"で"いつもお世話になってます!>_<b(>_<) Good Job!! >_< "などと打つとが表示がおかしくなる
doguestbook.phpのcommentのPOSTデータの処理で，
<>がhtmlの特殊文字として扱われているため，htmlspecialcharsを使ってエスケープ処理を加えた．

# Bug5
一度購入したものも、ログアウトしてカートに入れた後にログインすると、カートに入ったままで再度購入ができてしまう
ログインするときの処理であるlogin.phpに追記．
1. ログインユーザのuser_idを特定．
2. user_idからどのorderをしたのorder_idを特定．
3. そのオーダーから何の商品を注文したかをorder_itemsから特定．
4. そのアイテムが現在のセッション上のcartitemsに存在する場合は削除する．
普段こういう処理はActiveRecordでかなり簡易にできるので少し冗長ぎみになってしまいました．

# その他
全体的に，リンクが`action=/index.php`のようになっている．
`action=./index.php`としなければ正しくリンクが遷移しない場合があるので注意すること．

また，buy.phpでforeachのtypoを確認した．
typoを直した後もエラーが出るが購入は正しくできていたのであまり確認していない．

# セキュリティ的にまずいところ

ユーザからの入力を基本的にエスケープせずに受け取っているため，
SQLインジェクションなどの可能性が非常に高い．
PDOを利用しているので，quoteを用いてエスケープするのが一般的の模様．
というか，Bug4はインジェクションの問題かと思いこんでいたら，
実際はhtmlのエスケープの方の問題で少しはまりました．
